@{
    ViewBag.Title = "U-VU";
}
<div id="editor" oncontextmenu="return false;"></div>
<div id="logo"></div>
<div id="nav">
    <ul>
        <li>
            <a class="drop-menu-button">Town Search</a>
            <div class="drop-menu">
                <div style="padding:20px;">
                    <img src="~/Content/icons/search-3-24.png" class="icon" />
                    <h2>Search Towns</h2>
                    <input type="text" id="townSearch" />
                    <div id="results">

                    </div>
                </div>
            </div>
        </li>
        <li>
            <a class="drop-menu-button">Key</a>
            <div class="drop-menu">
                <img src="~/Content/images/key.png" />
            </div>
        </li>
        <li><a>About Us</a></li>
        <li><a>Contact</a></li>
        <li>
            <a class="drop-menu-button">Journey Planner</a>
            <div class="drop-menu">
                <input type="text" id="planFrom" /><br/>
                <input type="text" id="planTo" /><br/>
                <button id="btnGo">Go</button>
            </div>
        </li>
    </ul>
</div>

<div id="infoPopup">
    <div class="closeIcon"></div>
    <div class="mainInfo">

    </div>
</div>

@section scripts {
    <script src="/Scripts/jquery-ui-touch-punch.js"></script>
    <script src="/Scripts/jquery.mousewheel.js"></script>
    <script src="/Scripts/jquery.svg-pan-zoom.js"></script>
    <script src="/Scripts/handlebars.min.js"></script>
    <script src="/Scripts/handlebars.extensions.js"></script>
    <script src="/Scripts/site.js"></script>

    <script>
        (function() {
            var planSVG,
                fixedPort,
                editor,
                mainGroup,
                scaleGroup,
                townGroup,
                planImageGroup,
                planData,
                infoPopup,
                templates = {};

            var xmlns = {
                ns: 'http://www.w3.org/2000/svg',
                link: 'http://www.w3.org/1999/xlink'
            }

            var wireEvents = function () {
                editor = $('#editor');
                setLayout();
                $(window).resize(setLayout);
                editor.load('/Content/SVGData/Borders.svg', null, setupForm);
                infoPopup = $('#infoPopup');
                infoPopup.find('.closeIcon').click(function () { infoPopup.hide(); })
                templates.infoTemplate = Handlebars.compile($.trim($('#infoTemplate').html())); 
                templates.cubInfoTemplate = Handlebars.compile($.trim($('#cubInfoTemplate').html())); 
                templates.railInfoTemplate = Handlebars.compile($.trim($('#railInfoTemplate').html()));
                templates.jouneyPlanTemplate = Handlebars.compile($.trim($('#jouneyPlanTemplate').html()));
                $('#townSearch').keyup(searchTowns);
                $('#results').on('click', 'div', function () { gotoTown($(this).data('node')); });
                $('#btnGo').click(planJourney)
            }

            var planJourney = function () {
                var data = { to : $('#planTo').val(), from : $('#playFrom').val() }
                var displayData = templates.jouneyPlanTemplate(data)
                infoPopup.find('.mainInfo').html(displayData)
                infoPopup.find('iframe').load(function () {
                    infoPopup.find('iframe').show();
                    infoPopup.find('.loading').hide();
                })
                infoPopup.showPopup();
            }

            var searchTowns = function (e) {
                var string = $(this).val();
                var found = $('#townGroup text:containsIN("' + string + '")');
                $('#results').empty();
                if (found.length > 0) {
                    if (e.which == 13) {
                        gotoTown($(found[0]));
                    } else {
                        $.each(found, function (i, el) {
                            var result = $('<div/>').text($(el).text()).data('node',el);
                            $('#results').append(result);
                        });
                    }
                }
                
            }

            var gotoTown = function (found) {
                var zoom = 4;
                var transform = { e: -($(found).data('x')) * zoom, f: -($(found).data('y')) * zoom }
                transform.e = transform.e + ($(document).width() / 2);
                transform.f = transform.f + ($(document).height() / 2);
                planSVG.pxSVGPanZoom("zoomTo", { offset: { x: transform.e, y: transform.f }, zoom: zoom });
            }
            
            var onZoom = function (zoomLevel) {
                //console.log(zoomLevel);
                if (zoomLevel < 1.2) {
                    $(townGroup).hide();
                } else {
                    $(townGroup).show();
                }
            }

            var setupForm = function (e) {
                planSVG = editor.find('svg');

                mainGroup = document.createElementNS(xmlns.ns, "g"); // THIS IS FOR PANNING AND SCALING
                mainGroup.setAttribute('id', 'viewport');
                planSVG.append(mainGroup);

                $(mainGroup).append(planSVG.find('g[id]'));   

                //<image x="10" y="20" width="80" height="80" xlink:href="recursion.svg" />
                //var cubs = document.createElementNS(xmlns.ns, "image");
                //cubs.setAttribute("x", 0);
                //cubs.setAttribute("y", 0);
                //cubs.setAttribute("width", 6104);
                //cubs.setAttribute("height", 7538);
                //cubs.setAttributeNS(xmlns.link, "href", "/Content/SVGData/YellowCubs.svg");
                //planSVG.find('#Boundaries')[0].appendChild(cubs);

                fixedPort = document.createElementNS(xmlns.ns, "g") // THIS IS FOR OBJECT WE DON'T WANT SCALED
                fixedPort.setAttribute('id', 'fixedPort');
                planSVG.append(fixedPort);

                townGroup = document.createElementNS(xmlns.ns, "g"); // THIS IS FOR PANNING AND SCALING
                townGroup.setAttribute('id', 'townGroup');
                $(mainGroup).find('#Yellow_Cubs').after(townGroup);

                routeGroup = document.createElementNS(xmlns.ns, "g"); // THIS IS FOR PANNING AND SCALING
                routeGroup.setAttribute('id', 'routeGroup');
                $(mainGroup).find('#Yellow_Cubs').after(routeGroup);


                planSVG.pxSVGPanZoom({ onClick: mainPlanClick, onZoom: onZoom, min:0.5, max: 6.5 });
                planSVG.pxSVGPanZoom("zoomTo", { offset: { x: 226, y: -2492 }, zoom: 0.5 });

                $('#Yellow_Cubs polygon, #Yellow_Cubs path').click(function () {
                    var id = $(this).data('id');
                    var cub = $.grep(cubData, function (e) { return e.cubId == id; });
                    if (document.location.hostname == "localhost") cub[0].local = true;
                    openPopup(templates.cubInfoTemplate(cub[0]));
                });
                $('#Rail_Numbers text[data-number]').click(function() {
                    var number = $(this).data('number');
                    var rail = $.grep(railData, function (e) { return e.number == number; });
                    if (document.location.hostname == "localhost") rail[0].local = true;
                    openPopup(templates.railInfoTemplate(rail[0]));
                })

                loadPlan();

            }

            var mainPlanClick = function () {
                infoPopup.hide();
            }

            // Resize editor area to fit window
            var setLayout = function() {
                editor.css('height', window.innerHeight - editor.offset().top);
            }

            var loadPlan = function () {
                $.ajax('api/routes/gettowns/', { type: "GET" })
                    .done(drawTowns)
                    .error(function (jq, text, error) { alert('Error loading plan'); })
                $.ajax('/api/routes/getroutes', { type: "GET" })
                    .done(drawRoutes)
                    .error(function (jq, text, error) { alert('Jordan made me do it'); })
            }

            var drawRoutes = function (data) {
                $.each(data, function (i, e) {
                    var route = document.createElementNS(xmlns.ns, "g");
                    route.setAttribute('class', "route");
                    $(route).data('routeData', e);
                    $.each(e.RoutePaths, function (j, routePath) {
                        switch (routePath.type) {
                            case "path":
                                var RoutePathSvg = document.createElementNS(xmlns.ns, 'path');
                                RoutePathSvg.setAttribute('d', routePath.path)
                                
                                break;
                            case "polyline":
                                var RoutePathSvg = document.createElementNS(xmlns.ns, 'polyline');
                                RoutePathSvg.setAttribute('points', routePath.path)
                                break;

                            case "line":
                                var RoutePathSvg = document.createElementNS(xmlns.ns, 'line');
                                var points = routePath.path.split(' ');
                                RoutePathSvg.setAttribute('x1', points[0].split(',')[0]);
                                RoutePathSvg.setAttribute('y1', points[0].split(',')[1]);
                                RoutePathSvg.setAttribute('x2', points[1].split(',')[0]);
                                RoutePathSvg.setAttribute('y2', points[1].split(',')[1]);
                                break;
                        }
                        RoutePathSvg.setAttribute('stroke-width', routePath.weight)
                        RoutePathSvg.setAttribute('fill', 'none');
                        RoutePathSvg.setAttribute('stroke', '#' + e.operatorItem.colour);
                        //RoutePathSvg.setAttribute('class', "route");
                        route.appendChild(RoutePathSvg);
                    })


                    $.each(e.RouteNumbers, function (j, routenumber) {
                        var textNode = document.createTextNode(routenumber.number);
                        var RouteNumberSvg = document.createElementNS(xmlns.ns, 'text');
                        RouteNumberSvg.setAttribute('transform', 'matrix(1 0 0 1 ' + routenumber.x + ' ' + routenumber.y + ')')
                        //RouteNumberSvg.setAttribute('class', "route");
                        RouteNumberSvg.appendChild(textNode);
                        route.appendChild(RouteNumberSvg);

                    })

                    routeGroup.appendChild(route);
                });

                //editor.find('.route')

                editor.find('.route')
                    .on('mouseenter', 'polyline, path, line, text', function () {
                        var group = $(this).closest('g');
                        group[0].setAttribute('class', 'route over');
                        $(routeGroup).prepend(group.nextAll());
                        //$(routeGroup).append(group);
                    })
                    .on('mouseleave', 'polyline, path, line, text', function () {
                        var group = $(this).closest('g');
                        group[0].setAttribute('class', 'route');
                    })
                    .click(function () {
                        var group = $(this).closest('g');
                        var data = $(group).data('routeData');
                        var routeItem = $.grep(routeData, function (e) { return e.routeId == data.routeId; });
                        data.routeItem = routeItem[0];
                        if (document.location.hostname == "localhost") data.local = true;
                        openPopup(templates.infoTemplate(data));
                    })

            }

            var openPopup = function (displayData) {
                infoPopup.find('.mainInfo').html(displayData)
                infoPopup.find('iframe').load(function () {
                    infoPopup.find('iframe').show();
                    infoPopup.find('.loading').hide();
                })
                infoPopup.showPopup();

                infoPopup.find('.btnOverView').click(function () {
                    infoPopup.find('.sections').hide();
                    infoPopup.find('#divOverview').show();
                });
                infoPopup.find('.btnAllStops, .btnTimingPoints').click(function () {
                    infoPopup.find('.sections').hide();
                    infoPopup.find('#divTimingPoints').show();
                    infoPopup.find('.loading').show();
                    infoPopup.find('iframe').hide();
                    infoPopup.find('iframe').attr('src', $(this).data('url'));
                });
                infoPopup.find('.btnBackToMap').click(function () { infoPopup.hide(); })
            }

            var drawTowns = function(data) {

                $.each(data, function (i, e) {

                    var town = document.createElementNS(xmlns.ns, "g");
                    town.setAttribute('class', "town");

                    var TownCircleSvg = document.createElementNS(xmlns.ns,'circle');
                    TownCircleSvg.setAttribute('cx', e.location.split(' ')[0])
                    TownCircleSvg.setAttribute('cy', e.location.split(' ')[1])
                    TownCircleSvg.setAttribute('r', e.size)
                    town.appendChild(TownCircleSvg);

                    var TownNameSvg = document.createElementNS(xmlns.ns, 'text');
                    TownNameSvg.setAttribute('transform', 'matrix(1 0 0 1 ' + e.townNameLocation + ')')
                    TownNameSvg.setAttribute('font-size', 3 + e.size)
                    TownNameSvg.setAttribute('data-x', e.location.split(' ')[0])
                    TownNameSvg.setAttribute('data-y', e.location.split(' ')[1])

                    //if (e.townName.indexOf("~") > -1) {
                        var townLines = e.townName.split('~');
                        for(i=0;i<townLines.length;i++) {
                            var TSpanSvg = document.createElementNS(xmlns.ns, 'tspan');
                            TSpanSvg.setAttribute('x', 0);
                            TSpanSvg.setAttribute('dy', i*1 + 'em');
                            var textNode = document.createTextNode(townLines[i]);
                            TSpanSvg.appendChild(textNode);
                            TownNameSvg.appendChild(TSpanSvg);
                            town.appendChild(TownNameSvg);
                        }
                    //} else {
                        
                        //TownNameSvg.appendChild(textNode);
                        //town.appendChild(TownNameSvg);
                    //}
                    
                    townGroup.appendChild(town);
                    

                    //<circle fill="#AFAFAF" cx="2654.93" cy="5752.81" r="1.75"/>
                    //<text transform="matrix(1 0 0 1 2630.3809 5756.3867)" fill="#AFAFAF" font-family="'ArialMT'" font-size="6.0001">Holnest</text>

                })
            }

            $(function () {
                wireEvents();
            })

            var cubData = [
                { "cubId": 1, "cityName": "Plymouth", "pdfUrl": "http://assets.goaheadbus.com/media/cms_page_media/678/AW%20310315%20DD%2015-024%20CITYBUS%20SHOP%20MAP%20MARCH%202015.pdf", "webSite":"https://www.plymouthbus.co.uk/timetables/", "twitter":"https://twitter.com/plymouthbus" },
                { "cubId": 2, "cityName": "Exeter", "pdfUrl": "/Content/cubs/cub2.pdf", "webSite": "https://www.stagecoachbus.com/maps?nearbyLocation%5BCategory%5D=locality&nearbyLocation%5BGeocode%5D%5BGrid%5D%5Bvalue%5D=WGS84&nearbyLocation%5BGeocode%5D%5BLongitude%5D=-3.5240284589035453&nearbyLocation%5BGeocode%5D%5BLatitude%5D=50.72574040905496&nearbyLocation%5BGeocode%5D%5Bcallback%5D=undefined&nearbyLocation%5BFullText%5D=Exeter+Bus+Station%2C+Devon&nearbyLocation%5BLocalityData%5D%5BLocalityId%5D=ZYX25629&nearbyLocation%5Bid%5D=Exeter+Bus+Station%2C+Devon", "twitter": "https://twitter.com/StagecoachSW" },
                { "cubId": 3, "cityName": "Torbay", "pdfUrl": "/Content/cubs/cub3.pdf", "webSite": "https://www.stagecoachbus.com/maps?nearbyLocation%5BCategory%5D=locality&nearbyLocation%5BGeocode%5D%5BGrid%5D%5Bvalue%5D=WGS84&nearbyLocation%5BGeocode%5D%5BLongitude%5D=-3.527759490351937&nearbyLocation%5BGeocode%5D%5BLatitude%5D=50.46452081789005&nearbyLocation%5BGeocode%5D%5Bcallback%5D=undefined&nearbyLocation%5BFullText%5D=Torquay%2C+Torbay&nearbyLocation%5BLocalityData%5D%5BLocalityId%5D=ZYX12736&nearbyLocation%5Bid%5D=Torquay%2C+Torbay", "twitter": "https://twitter.com/StagecoachSW" },
                { "cubId": 4, "cityName": "Taunton", "pdfUrl": "http://www.busesofsomerset.co.uk/pdfs/maps/tauntonapr15.pdf", "webSite": "http://www.busesofsomerset.co.uk/timetables.shtml", "twitter": "https://twitter.com/FirstKernow" },
                { "cubId": 5, "cityName": "Yoevil", "pdfUrl": "", "webSite": "", "twitter": "" },
                { "cubId": 6, "cityName": "Weymouth", "pdfUrl": "", "webSite": "", "twitter": "" },
            ];

            var railData = [
                { "railId": 1, "number": "135", "pdfUrl": "http://www.networkrail.co.uk/browse%20documents/eNRT/May15/timetables/Table%20135.pdf" },
                { "railId": 2, "number": "136", "pdfUrl": "http://www.networkrail.co.uk/browse%20documents/eNRT/May15/timetables/Table%20136.pdf" },
                { "railId": 3, "number": "139", "pdfUrl": "http://www.networkrail.co.uk/browse%20documents/eNRT/May15/timetables/Table%20139.pdf" },
                { "railId": 4, "number": "140", "pdfUrl": "http://www.networkrail.co.uk/browse%20documents/eNRT/May15/timetables/Table%20140.pdf" },
                { "railId": 5, "number": "142", "pdfUrl": "http://www.networkrail.co.uk/browse%20documents/eNRT/May15/timetables/Table%20142.pdf" },
                { "railId": 6, "number": "143", "pdfUrl": "http://www.networkrail.co.uk/browse%20documents/eNRT/May15/timetables/Table%20143.pdf" },
                { "railId": 7, "number": "144", "pdfUrl": "http://www.networkrail.co.uk/browse%20documents/eNRT/May15/timetables/Table%20144.pdf" },
                { "railId": 8, "number": "160", "pdfUrl": "http://www.networkrail.co.uk/browse%20documents/eNRT/May15/timetables/Table%20160.pdf" }
            ];

            var routeData = [
                //PURPLE
                { "routeId": 854, "times": [["70/70A", "60", "60", "120", "Irregular"]], "ns": false },
                { "routeId": 855, "times": [["46", "60/120", "60/120", "~", "~"]], "ns": false },
                { "routeId": 856, "times": [["11/11A", "30", "30", "120", "120*"], ["11A", "60", "60", "120", "~"]], "ns": true },
                { "routeId": 857, "times": [["72", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 858, "times": [["73", "60", "60", "120", "~"]], "ns": false },
                { "routeId": 859, "times": [["74", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 860, "times": [["79/79A", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 861, "times": [["12 Plymouth - Callington", "30", "30", "60", "120*"], ["12 Callington - Launceston", "60", "60", "120", "irregular*"], ["12 Launceston - Bude", "120", "120", "~", "~"]], "ns": true },
                { "routeId": 863, "times": [["101", "?", "", "", ""]], "ns": false },
                { "routeId": 864, "times": [["183", "?", "", "", ""]], "ns": false },
                { "routeId": 865, "times": [["X10", "irregular", "irregular", "~", "~"]], "ns": false },
                { "routeId": 866, "times": [["40 Bridport - Beaminster", "60", "60/120", "~", "~"], ["40 Beaminster - Yeovil", "irregular", "irregular", "~", "~"]], "ns": false },
                { "routeId": 867, "times": [["20A", "60", "60", "~", "~"]], "ns": false },

                //PINK
                { "routeId": 804, "times": [["1-1a","120", "120", "150*", "No Service"]], "ns": true },
                { "routeId": 799, "times": [["2 Penzance - Helston","60", "60", "120", "120*"], ["2 Helston - Falmouth","120", "120", "~", "~"]], "ns": true },
                { "routeId": 795, "times": [["5 - 6A", "60", "60", "~", "120*"]], "ns": true },
                { "routeId": 797, "times": [["10", "60", "60", "120", "120*"],["10A", "60", "60", "~", "~"]], "ns": true },
                { "routeId": 827, "times": [["14", "30", "30", "60", "~"] ["18", "30", "30", "60", "60*"],["14/18 Combined", "10", "15", "30", "60*"]], "ns": true },
                { "routeId": 825, "times": [["14", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 810, "times": [["16 - 16A", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 796, "times": [["16 - 16A", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 809, "times": [["17", "30", "30", "60", "60*"]], "ns": true },
                { "routeId": 831, "times": [["21", "60", "60", "120", "120*"]], "ns": true },
                { "routeId": 786, "times": [["21 - 21A", "15", "15", "60", "early evening only"],["21 Burnham - Weston", "60", "60", "60", "~"]], "ns": false },  //Taunton
                { "routeId": 830, "times": [["22", "irregular", "iregular", "~", "~"]], "ns": false },
                { "routeId": 838, "times": [["22 - 22A", "15", "15", "60", "Early evening only"],["22", "30", "30", "60", "Early evening only"],["22A", "30", "30", "60", "Early evening only"]], "ns": false }, //Taunton
                { "routeId": 784, "times": [["22 - 22A", "15", "15", "60", "Early evening only"],["22", "30", "30", "60", "Early evening only"],["22A", "30", "30", "60", "Early evening only"]], "ns": false }, //Taunton
                { "routeId": 803, "times": [["24", "60", "60", "120", "120*"]], "ns": true },
                { "routeId": 807, "times": [["25 Newquay - St Steph", "120", "120", "~", "~"],["25 St Steph - Fowey", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 783, "times": [["25 Taunton - Wiveliscombe", "60", "60", "~", "~"],["25 Taunton - Wiveliscombe", "120", "120", "~", "~"]], "ns": false }, // Taunton
                { "routeId": 808, "times": [["27", "60", "60", "120", "120*"]], "ns": true },
                { "routeId": 785, "times": [["28", "30", "30", "60", "Early Evening only"]], "ns": false },
                { "routeId": 790, "times": [["29", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 792, "times": [["30", "90", "90", "~", "~"]], "ns": false },
                { "routeId": 801, "times": [["35", "60", "60", "~", "~"] ,["35A", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 800, "times": [["35", "60", "60", "~", "~"] ,["35A", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 822, "times": [["36", "Irregular", "Irregular", "Irregular*", "~"],["* No Sunday service between St Keverne and Helston"]], "ns": false },
                { "routeId": 823, "times": [["37", "60/120", "60/120", "120", "Limited Mondau to Saturday"]], "ns": true },
                { "routeId": 798, "times": [["39", "120", "120", "~", "~"], ["39a", "120", "120", "~", "~"], ["45", "120", "120", "~", "~"], ["39/29a/45", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 806, "times": [["39", "120", "120", "~", "~"], ["39a", "120", "120", "~", "~"], ["45", "120", "120", "~", "~"], ["39/29a/45", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 824, "times": [["39", "120", "120", "~", "~"], ["39a", "120", "120", "~", "~"], ["45", "120", "120", "~", "~"], ["39/29a/45", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 839, "times": [["46 Camborne - Redruth", "60", "60", "~", "~"], ["46 Redruth - Truro", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 814, "times": [["47", "60", "60", "120", "120*"]], "ns": true },
                { "routeId": 817, "times": [["50", "120", "120", "120", "~"] ["51", "120", "120", "~", "~"], ["50/51 Combined", "60", "60", "120", "~"]], "ns": false },
                { "routeId": 818, "times": [["50", "120", "120", "120", "~"] ["51", "120", "120", "~", "~"], ["50/51 Combined", "60", "60", "120", "~"]], "ns": false },
                { "routeId": 820, "times": [["56", "90", "90", "Irregular", "~"]], "ns": false },
                { "routeId": 836, "times": [["57/58", "30/60", "30/60", "~", "~"], ["58", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 789, "times": [["57/58", "30/60", "30/60", "~", "~"], ["58", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 813, "times": [["69", "120", "120", "~", "~"] ,["69A", "120", "120", "~", "~"] ["69/69A combined", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 816, "times": [["85", "90", "90", "~", "~"]], "ns": false },
                { "routeId": 815, "times": [["87", "60", "60", "120", "120*"]], "ns": true },
                { "routeId": 826, "times": [["90", "60", "60", "~", "~"], ["93", "60", "60", "120", "120*"]], "ns": true },
                { "routeId": 829, "times": [["90", "60", "60", "~", "~"], ["93", "60", "60", "120", "120*"]], "ns": true },
                { "routeId": 802, "times": [["101", "60", "60", "60", "~"]], "ns": true },
                { "routeId": 788, "times": [["161", "60", "60", "60", "~"]], "ns": false },
                { "routeId": 834, "times": [["173", "60", "60", "60", "Early evening only"], ["174", "60", "60", "~", "~"], ["173/174", "30", "30", "60", "Early evening only"]], "ns": false },
                { "routeId": 832, "times": [["375", "60", "60", "~", "~"], ["376", "30", "30", "30", "60"], ["377", "60", "60", "~", "~"], ["375/376/377 Combined", "10/20", "10/20", "30", "60"]], "ns": false },
                { "routeId": 787, "times": [["375", "60", "60", "~", "~"], ["376", "30", "30", "30", "60"], ["377", "60", "60", "~", "~"], ["375/376/377 Combined", "10/20", "10/20", "30", "60"]], "ns": false },
                { "routeId": 791, "times": [["375", "60", "60", "~", "~"], ["376", "30", "30", "30", "60"], ["377", "60", "60", "~", "~"], ["375/376/377 Combined", "10/20", "10/20", "30", "60"]], "ns": false },
                { "routeId": 811, "times": [["U1", "30", "30", "60", "60*"], ["U2", "30", "30", "60", "60*"], ["U1/U2/U3 Combined", "10-20", "10-20", "30", "30*"], ["* No evening service on Sundays"]], "ns": false },
                { "routeId": 812, "times": [["U1", "30", "30", "60", "60*"], ["U2", "30", "30", "60", "60*"], ["U1/U2/U3 Combined", "10-20", "10-20", "30", "30*"], ["* No evening service on Sundays"]], "ns": false },
                { "routeId": 793, "times": [["X53 Exeter - Axminster", "Irregular", "Irregular", "~", "~"], ["X51/X53 - Axminster - Bridport", "30", "30", "120", "~"], ["X51 Bridport - Dorchester", "60", "60", "~", "~"], ["X53 - Bridport - Poole", "Irregular", "Irregular", "120*", "~"], ["* Bridport to Weymouth only"]], "ns": false },
                { "routeId": 837, "times": [["X53 Exeter - Axminster", "Irregular", "Irregular", "~", "~"], ["X51/X53 - Axminster - Bridport", "30", "30", "120", "~"], ["X51 Bridport - Dorchester", "60", "60", "~", "~"], ["X53 - Bridport - Poole", "Irregular", "Irregular", "120*", "~"], ["* Bridport to Weymouth only"]], "ns": false },

                //RED
                { "routeId": 881, "times": [["1/1A/1B", "20", "20", "120", "Irregular"], ["1", "60", "60", "120", "~"], ["1A", "60", "60", "120", "~"]], "ns": false },
                { "routeId": 882, "times": [["1/1A/1B", "20", "20", "120", "Irregular"], ["1", "60", "60", "120", "~"], ["1A", "60", "60", "120", "~"]], "ns": false },
                { "routeId": 914, "times": [["1", "30", "30", "60", "60"], ["X1", "30", "30", "~", "~"]], "ns": false },
                { "routeId": 889, "times": [["2", "20", "20", "60", "60"]], "ns": false },
                { "routeId": 915, "times": [["3", "60", "60", "Irregular*", "~"]], "ns": false },
                { "routeId": 884, "times": [["4", "60", "60", "~", "Limited Service"], ["4/4A", "30", "30", "~", "~"]], "ns": false },
                { "routeId": 885, "times": [["4", "60", "60", "~", "Limited Service"], ["4/4A", "30", "30", "~", "~"]], "ns": false },
                { "routeId": 897, "times": [["5,5A,5B,5C Combined", "15", "15", "30", "Harley to Crediton limiteeeeed service to north tawton and Barnstaple"], ["5A,5B,Combined", "60", "60", "~", "~"], ["5A", "120", "120", "~", "~"], ["5B", "120", "120", "~", "~"], ["5C", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 903, "times": [["5,5A,5B,5C Combined", "15", "15", "30", "Harley to Crediton limiteeeeed service to north tawton and Barnstaple"], ["5A,5B,Combined", "60", "60", "~", "~"], ["5A", "120", "120", "~", "~"], ["5B", "120", "120", "~", "~"], ["5C", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 904, "times": [["5,5A,5B,5C Combined", "15", "15", "30", "Harley to Crediton limiteeeeed service to north tawton and Barnstaple"], ["5A,5B,Combined", "60", "60", "~", "~"], ["5A", "120", "120", "~", "~"], ["5B", "120", "120", "~", "~"], ["5C", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 901, "times": [["5,5A,5B,5C Combined", "15", "15", "30", "Harley to Crediton limiteeeeed service to north tawton and Barnstaple"], ["5A,5B,Combined", "60", "60", "~", "~"], ["5A", "120", "120", "~", "~"], ["5B", "120", "120", "~", "~"], ["5C", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 899, "times": [["6", "Irregular", "Irregular", "Irregular", "Limited"]], "ns": false },
                { "routeId": 898, "times": [["6A", "Irregular", "Irregular", "Irregular", "~"]], "ns": false },
                { "routeId": 891, "times": [["11", "60", "60", "60", "120"]], "ns": false },
                { "routeId": 890, "times": [["12", "10", "10", "15", "20"]], "ns": false },
                { "routeId": 869, "times": [["18, 18A", "30", "60", "Early evening only", "~"]], "ns": false },
                { "routeId": 909, "times": [["20", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 880, "times": [["21", "20", "20", "60", "60"], ["21A", "20*", "20*", "60", "60**"], ["21/21A", "10", "10", "30", "30"], ["* 60 Braunton to Georgeham"], ["** 60 Not Braunton to Georgeham"]], "ns": false },
                { "routeId": 879, "times": [["21", "20", "20", "60", "60"], ["21A", "20*", "20*", "60", "60**"], ["21/21A", "10", "10", "30", "30"], ["* 60 Braunton to Georgeham"], ["** 60 Not Braunton to Georgeham"]], "ns": false },
                { "routeId": 894, "times": [["39", "60", "60", "120", "~"]], "ns": false },
                { "routeId": 913, "times": [["48", "90", "90", "~", "~"]], "ns": false },
                { "routeId": 916, "times": [["52A", "60", "60", "~", "Hourly Exeter to Sidmouth/Sidbury only"], ["52B", "60", "60", "~"], ["52A/52B Combined", "30", "30", "60"]], "ns": false },
                { "routeId": 883, "times": [["52A", "60", "60", "~", "Hourly Exeter to Sidmouth/Sidbury only"], ["52B", "60", "60", "~"], ["52A/52B Combined", "30", "30", "60"]], "ns": false },
                { "routeId": 911, "times": [["57", "15", "15", "30", "60"]], "ns": false },
                { "routeId": 912, "times": [["66,66B", "60", "60", "~", "Limited service"]], "ns": false },
                { "routeId": 871, "times": [["66,66B", "60", "60", "~", "Limited service"]], "ns": false },
                { "routeId": 878, "times": [["71/72", "60", "60", "~", "~"], ["71/72", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 907, "times": [["71/72", "60", "60", "~", "~"], ["71/72", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 877, "times": [["75/75A", "60", "60", "~", "~"], ["75A", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 900, "times": [["75/75A", "60", "60", "~", "~"], ["75A", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 876, "times": [["85", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 895, "times": [["88", "30/60", "30/60", "~", "~"]], "ns": false },
                { "routeId": 905, "times": [["99, 99A", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 910, "times": [["99, 99A", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 870, "times": [["120", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 902, "times": [["55/155", "30", "30", "120", "Irregular"], ["155", "120*", "120*", "~", "Early evening only"], ["*60 South Molton to Barnstaple"]], "ns": false },
                { "routeId": 906, "times": [["55/155", "30", "30", "120", "Irregular"], ["155", "120*", "120*", "~", "Early evening only"], ["*60 South Molton to Barnstaple"]], "ns": false },
                { "routeId": 887, "times": [["157/357", "30", "30", "60", "60"], ["157", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 888, "times": [["157/357", "30", "30", "60", "60"], ["157", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 872, "times": [["Gold", "30", "30", "60", "Irregular"]], "ns": false },
                { "routeId": 896, "times": [["X38", "120", "120", "Irregular", "~"]], "ns": false },
                { "routeId": 893, "times": [["X46", "90", "90", "Irregular", "~"]], "ns": false },
                { "routeId": 892, "times": [["X64", "120", "120", "Irregular", "~"]], "ns": false },

                //GREEN
                { "routeId": 739, "times": [["10", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 763, "times": [["15/76", "30", "30", "~", "~"], ["12/15", "15", "15", "~", "~"], ["12", "30", "30", "~", "~"]], "ns": false },
                { "routeId": 765, "times": [["16", "120", "120", "~", "~"], ["24", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 738, "times": [["18", "30", "30", "~", "~"]], "ns": false },
                { "routeId": 779, "times": [["31", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 774, "times": [["38", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 767, "times": [["51", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 755, "times": [["55 Tavistock - Yelverton", "Irregular", "Irregular", "~", "~"], ["55 Yelverton - Milton Combe", "90", "90", "~", "~"]], "ns": false },
                { "routeId": 756, "times": [["56", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 776, "times": [["59", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 771, "times": [["67", "90", "90", "~", "~"]], "ns": false },
                { "routeId": 768, "times": [["68", "60", "60", "~", "Early evening only"]], "ns": false },
                { "routeId": 770, "times": [["10", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 772, "times": [["10", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 773, "times": [["10", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 769, "times": [["81", "60", "120", "~", "~"]], "ns": false },
                { "routeId": 757, "times": [["87/87A", "60", "60", "~", "~"], ["87A", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 762, "times": [["94", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 734, "times": [["98", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 735, "times": [["162", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 742, "times": [["165", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 746, "times": [["173", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 740, "times": [["176", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 741, "times": [["177", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 745, "times": [["178", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 730, "times": [["301", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 759, "times": [["303", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 733, "times": [["304", "60", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 781, "times": [["309/310", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 782, "times": [["309/310", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 732, "times": [["315", "120", "120", "~", "~"]], "ns": true },
                { "routeId": 778, "times": [["359", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 758, "times": [["360", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 761, "times": [["382", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 764, "times": [["398", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 777, "times": [["409", "Irregular", "Irregular", "~", "~"]], "ns": true },
                { "routeId": 754, "times": [["410", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 753, "times": [["425", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 747, "times": [["442", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 751, "times": [["471", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 750, "times": [["493", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 749, "times": [["496", "Irregular", "Iregular", "~", "~"]], "ns": false },
                { "routeId": 748, "times": [["497", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 736, "times": [["606", "60", "60", "~", "~"]], "ns": false },
                { "routeId": 737, "times": [["660", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 744, "times": [["669", "120", "120", "~", "~"]], "ns": false },
                { "routeId": 743, "times": [["856", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 917, "times": [["859", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 760, "times": [["899", "Irregular", "Irregular", "~", "~"]], "ns": false },
                { "routeId": 766, "times": [["N10", "Irregular", "Irregular", "~", "~"]], "ns": false }
            ];
        }())

        function frameLoaded() {
            var parent = $(this).closest('.scroll');
            $(this).show().css('opacity', '1');
            parent.find('.loading').hide();
        }




    </script>

    <script type="text/x-handlebars" id="railInfoTemplate">
        <h1>Rail Number {{number}}</h1>
        <div class="scroll">
            {{#unless pdfUrl}}Sorry, no timetable for this area yet! :-({{/unless}}
            {{#if pdfUrl}}<span class="loading"></span>{{/if}}
            {{#if local}}
                <iframe src="/content/pdfs/rail/rail{{railId}}.pdf" style="width:100%;height:100%;position:relative;" onload="frameLoaded();"></iframe>
            {{else}}
                <iframe src="{{pdfUrl}}" style="width:100%;height:100%;position:relative;" onload="frameLoaded();"></iframe>
            {{/if}}
        </div>
    </script>

    <script type="text/x-handlebars" id="cubInfoTemplate">
        <h1>{{cityName}}</h1>
        <div {{bindData this}} class="buttonBar">
            {{#if twitter}}<a href="{{twitter}}" target="_blank" class="button"><img src="/Content/icons/twitter-icon.png"></a>{{/if}}
            {{#if webSite}}<a href="{{webSite}}" target="_blank" class="button"><img src="/Content/icons/website-icon.png"></a>{{/if}}
        </div>
        <div class="scroll">
            {{#unless pdfUrl}}Sorry, no timetable for this area yet! :-({{/unless}}
            {{#if pdfUrl}}<span class="loading"></span>{{/if}}
            {{#if local}}
                <iframe src="/content/pdfs/cubs/cub{{cubId}}.pdf" style="width:100%;height:100%;position:relative;" onload="frameLoaded();"></iframe>
            {{else}}
                <iframe src="{{pdfUrl}}" style="width:100%;height:100%;position:relative;" onload="frameLoaded();"></iframe>
            {{/if}}
        </div>
    </script>

    <script type="text/x-handlebars" id="infoTemplate">
        <h1>{{operatorItem.name}}</h1> 
        
        <div class="scroll">
            <div id="divOverview" class="sections">
                <div style="text-align:center;background:#E9E8E8;">
                    <img src="/Content/overview/{{routeId}}o.png" style="max-width:530px;width:100%;" />
                </div>
                <h2 style="background:#E9E8E8;border:2px solid #9ABDE3;padding:2px;margin:5px 0;text-align:center;color:#000;font-size:16px;">Daytime frequency in minutes</h2>

                <div style="background:#99BDE2;color:#000;padding:20px;position: absolute;top: 240px;bottom:0;">
                    <table class="routeTimes">
                        <tr>
                            <th>&nbsp;</th>
                            <th>Monday to Friday</th>
                            <th>Saturday</th>
                            <th>Sunday</th>
                            <th>Evening Service</th>
                        </tr>
                        {{#each routeItem.times}}
                        <tr>
                            {{#each this}}
                                <td>{{this}}</td>
                            {{/each}}
                        </tr>
                        {{/each}}
                    </table>
                    {{#if routeItem.ns}}<p>* No evening service on Sundays</p>{{/if}}
                    <p><strong>NOTES:</strong> Blue figures show typical off-peak journey times; journey times in peak hours are likely to be longer and in the evenings and on Sunday, shorter.  Evening service is generally from around 18.30.</p>
                </div>

            </div>
            <div id="divTimingPoints" class="sections" style="display:none;height:100%;">
                {{#unless allStopsUrl}}Sorry, no timetable for this route yet! :-({{/unless}}
                {{#if allStopsUrl}}<span class="loading"></span>{{/if}}
                {{#if local}}
                <iframe src="/content/pdfs/{{routeId}}_1.pdf" style="width:100%;height:100%;position:relative;" onload="frameLoaded();"></iframe>
                {{else}}
                <iframe src="{{timingPointsUrl}}" style="width:100%;height:100%;position:relative;" onload="frameLoaded();"></iframe>
                {{/if}}
            </div>
        </div>

        <div {{bindData this}} class="buttonBar">
            <ul>
                <li><a class="button btnOverView">Overview</a></li>
                {{#if local}}
                <li><a data-url="/content/pdfs/{{routeId}}_1.pdf" class="button btnTimingPoints">Timetable</a></li>
                <li><a data-url="/content/pdfs/{{routeId}}_0.pdf" class="button btnAllStops">All Stops</a></li>
                {{else}}
                <li><a data-url="{{timingPointsUrl}}" class="button btnTimingPoints">Timetable</a></li>
                <li><a data-url="{{allStopsUrl}}" class="button btnAllStops">All Stops</a></li>
                {{/if}}
                <li><a class="button btnJourneyPlanner">Journey Planner</a></li>
                {{#if operatorItem.twitter}}
                <li><a href="{{operatorItem.twitter}}" target="_blank" class="button"><img src="/Content/icons/twitter-icon.png">Real Time</a></li>
                {{/if}}
                <li><a class="button btnBackToMap">Back to Map</a></li>
            </ul>
        </div>
    </script>

    <script type="text/x-handlebars" id="jouneyPlanTemplate">
        <h1>Jouney Planner</h1>
        <div class="scroll">
            <span class="loading"></span>
            <iframe src="https://www.google.com/maps/preview?saddr={{from}}&daddr={{to}}&dirflg=r&output=embed" style="width:100%;height:100%;position:relative;"></iframe>
        </div>
    </script>
    
}